User-Based RBAC in Kubernetes
----------------------------


-------------------------------------------------
| Component   | Purpose                          |
| ----------- | -------------------------------- |
| CSR         | Request user authentication      |
| Role        | Define permissions               |
| RoleBinding | Link role to a user              |
| Kubeconfig  | Store user credentials & context |


*.key ‚Üí generated first (private key)

*.csr ‚Üí created using the key / Signing Request

*.crt ‚Üí Certificate




Workflow
---------
[Generate Private Key] ------> signs ------> [CSR] -----> sent to CA (verified or self signed)-----> [CRT issued]


Certificate Signing Request (CSR)

Delete if any existing ns called development

Note: you should not be in same namespace if you want to delete. Move out of it to another namespace like default and delete

-- kubectl config set-context --current --namespace=default
-- kubectl delete namespace <namespace-name>


Let‚Äôs say we have a Kubernetes namespace called ‚Äúdevelopment‚Äù and we want to grant permissions to a user named ‚Äúdev-user‚Äù to manage pods within that namespace.

Create a namespace called development
---------------------------------

-- kubectl create ns development

-- kubectl config set-context --current --namespace=development

Have some sample pods running in development namespace
--------------------------------------------------

vi deploynew.yml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: mb-deployment
  labels:
    app: bank
spec:
  replicas: 4
  selector:
    matchLabels:
      app: bank
  template:
    metadata:
      labels:
        app: bank
    spec:
      containers:
      - name: cont1
        image: trainerreyaz/mb-image:latest

-- kubectl create -f deploynew.yml

-- kubectl get pods



üë§ Scenario
------------
You want to create a user dev-user who:

Can only list and get pods

Works only in the development namespace


| Component      | Description                                       |
| -------------- | ------------------------------------------------- |
| `dev-user.key` | Private key                                       |
| `dev-user.csr` | Certificate Signing Request                       |
| `dev-user.crt` | User certificate issued by K8s CA                 |
| `kubeconfig`   | Lets user connect securely with restricted access |
| `Role`         | Grants specific permissions in a namespace        |
| `RoleBinding`  | Binds the user (CN) to the Role                   |




üîπ 1. Create a Private Key and Certificate Signing Request (CSR)
------------------------------------------------------------------

openssl genrsa -out dev-user.key 2048   [To create a Private Key]

openssl req -new -key dev-user.key -out dev-user.csr -subj "/CN=dev-user/O=dev-group"     [To create a CSR]

üîπ 2. Base64 Encode the CSR
----------------------------

cat dev-user.csr | base64 | tr -d '\n'

it show the key

LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ2JEQ0NBVlFDQVFBd0p6RVJNQThHQTFVRUF3d0laR1YyTFhWelpYSXhFakFRQmdOVkJBb01DV1JsZGkxbgpjbTkxY0RDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBS2t6TjJRWEcxbTJ5eEtxCnF1WDhSWDRrb1JIQkQxNCttcVlBb0REWG1yd1o4SGk4YkFjNkgwRXluVHJ3S243SjNjQTJzS0Y5VVJxUEV1b3IKTlZzUEt1Y09pVE50dzh4bzhvSTBMOGNRRnNGTW94QlBvSTRFMTcyL3JDRjFBSVkxWklrT2hnYkZxRW5BOElMYgowK003blpjalR6bDNlMmZaRk1rQmpQSHpwYTEzTjJIVFZGYzFPRHVvd2FHd2I3clRIOVd6MGcrMlVxdGdWUEpjCktzZFRKNitic256WWo1Y25XSkxZSVIvQ0J4eklrYjAwT1RKNnpYRjYza1JVMFFJc25QU2lnOEd1eVVkYmRlekoKTFU1VStxWE9OQlF5eVpGSWM2ME1nM3A4TE1CTi9KNzZxbmM5S1VzcXMxWWM4ZjErd3MzTWRSUUZlMXh2ZjV6agpLdWdDV2RjQ0F3RUFBYUFBTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFDU05DSmFWQXFCbDVZN3VOU2UwRWw2ClB0MStlUStiVDJSRkFXNDlOWW1GdlRWRDJCaDRwVnlrRXNsSk1tNmlYOGFhdFNBVU1OR2d5b2tBeFp5ZlduWUUKdTdlL1RwWW80ZlVFNUNEUzhNRVdTSzJzYU5oTjMzem1yNmwrVis4MUVKc0VhYzcxbjBLS01sU0xGa0c5WkozdQpEY3NFOE5UaVZ3UUV2VFVQaFREQmZKVzBMQ21XZytlQVNEV1VPbHA0cGJZUzRtTUdMYVo0dGFHUTBkN0JoUmJyCktVa1VzL3NKazJMV2prQWVobHJ6UEk1elhwSS9wanJkUFVPYW42ZWp5K3diZUpSd2c5WVo0S3QwS01Ob0sxU04KdEFzTjNRYkgyb3g0a2pSR0UrTlZmWnhYUlJESFVidU5NdEwyY3Rma3FrUWNTNGxYMzQyd0s4UmFYS1hHeWtzRQotLS0tLUVORCBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0K

üîπ 3. Create a Kubernetes CSR Resource
---------------------------------------

cat <<EOF | kubectl apply -f -
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: dev-user
spec:
  request: <base64_csr_output_here> HERE COPY ABOVE CODE
  signerName: kubernetes.io/kube-apiserver-client
  usages:
    - client auth
EOF

üîπ 4. Approve the CSR
--------------------

kubectl certificate approve dev-user

Get the signed cert:
-------------------

kubectl get csr dev-user -o jsonpath='{.status.certificate}' | base64 --decode > dev-user.crt


Now you have:
-------------
dev-user.key ‚Äì Private key
dev-user.crt ‚Äì Signed certificate

üîπ 5. Add User to Kubeconfig
-------------------------------

kubectl config set-credentials dev-user \
  --client-certificate=dev-user.crt \
  --client-key=dev-user.key

Then add a context:

kubectl config set-context dev-user-context \
  --cluster=reyaz.k8s.local \
  --namespace=development \
  --user=dev-user

FYI: to get cluster name: 
-- kubectl config get-clusters


üîπ 6. Create Role & RoleBinding for the User
----------------------------------------------

vi role.yml

# role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: development
  name: pod-reader
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]

---
# binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: dev-user-binding
  namespace: development
subjects:
- kind: User
  name: dev-user
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io



kubectl apply -f role.yml

üîπ 7. Test the Access as dev-user
------------------------------------

kubectl --context=dev-user-context get pods

Try to delete:
-------------
kubectl --context=dev-user-context delete pod ib-deployment-649699fd55-4qhhp

you get forbidden


If you want to do all these things in single shot . i have a script in GitHub -- setup-dev-user-rbac.sh



chmod +x setup-dev-user-rbac.sh

./setup-dev-user-rbac.sh

set the context
---------------
kubectl --context=dev-user-context get pods

try deleting
------------
kubectl --context=dev-user-context delete pod <pod-name>   # should be forbidden


Delete the users , role , rolebinding
------------------------------------

kubectl delete rolebinding dev-user-binding -n development
kubectl delete role pod-reader -n development
kubectl delete csr dev-user
kubectl config delete-context dev-user-context
kubectl config delete-user dev-user
rm -f dev-user.key dev-user.crt dev-user.csr

