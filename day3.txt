VOLUME:
--------
Docker volumes are a way to persist data generated by and used by Docker containers.

Volumes are stored on the host filesystem outside of the container's filesystem, which means they are not deleted when the container stops.

This makes them ideal for managing persistent data.

In Short
-------

If you want to store the data in container use volumes
volume is just a folder in container
containers use host resources (cpu, ram, )
volume can be shared to multiple containers.
At a time we can share single volume.
data inside volume will store on local.

Method 1 -- creating volume from Dockerfile
----------------------------------------

vi Dockerfile

FROM ubuntu
VOLUME ["volume1"]


-- docker build -t reyaz:v1 .

-- docker run -it --name cont1 reyaz:v1

ls --> you will be in container automatically and do ls -- you can see volume1

cd volume1

touch file{1..5}

--> what ever data you have created in container in volume1 the same data will be in docker host and vice versa
it is bidirectional -- if you create data in docker host it will be available in container also

comeout of the container ctrl pq and go to the below path

/var/lib/docker/volumes -- is the place where volume data is stored

touch python{1..5}  --> create some sample files, it should be visible inside container

-- docker attach cont1

if stopped docker start cont1

docker attach cont1

cd volume1

ls

------------------ SHARE THE VOLUME ------------------

If you want to get the same volume to another container

-- docker run -it --name cont2 --volumes-from cont1 ubuntu

Optional
docker run -it --name cont2 --volumes-from cont1 --privileged=true  ubuntu

ls

cd volume1


come out of the container ctrl pq

docker ps -a

--> Ex: create a new container with same volume : just an example

docker run -it --name cont3 --volumes-from cont2 ubuntu


Method 2 - Creating volume from the command directly
-------

docker images

docker run -it --name cont4 -v /volume2 ubuntu

cd volume2/

touch python{1..5}

ctrl pq

--> now share the volume from cont4 to cont5

docker run -it --name cont5 --volumes-from cont4 ubuntu
ls
cd volume2
now you can see the same data
create files here , we can see the same data in cont4 also
touch python{6..10}

ctrl pq

docker attach cont4  --> connect to cont4 to see the data , same data available
ls

--> you can see the same data also in docker host /var/lib/docker/volumes/



Method 3 -- Volume Mounting  
--------
Now you are in docker host

docker volume ls

docker volume create volume3

docker volume inspect volume3

cd /var/lib/docker/volumes/volume3/_data  -- in docker host

touch html{1..5}

docker run -it --name cont6 --mount source=volume3,destination=/volume3 ubuntu

now you are in container 6 , cd /volume3 and ls

now create files here , it will be available on docker host

if you delete, everywhere it is deleted


4. SHARING LOCAL FILES to Container
----------------------------------

be in docker host
touch reyaz{1..10}
docker volume inspect volume3
cp * /var/lib/docker/volumes/volume3/_data
docker attach cont6
cd volume3


Use AWS EBS Volumes to docker containers
---------------------------------------

Create 20GB EBS volume in AWS Console

Attach to the EC2 instance as /dev/xvdb

lsblk
sudo mkfs -t ext4 /dev/xvdb        ----- format the disk before use
sudo mkdir /mnt/ebs-volume
sudo mount /dev/xvdb /mnt/ebs-volume
docker images
docker run -it  --name my-container1 -v /mnt/ebs-volume:/mynewebsvolume ubuntu
  -- ls
  -- cd mynewebsvolume
  -- touch hello

-- create a another container with new name from before container

docker run -it --name mynewcont2 --volumes-from my-container1  ubuntu

  -- ls
  -- cd mynewebsvolume

you see the same data in all containers



DOCKER SYSTEM COMMANDS:
----------------------
to know the docker components resource utilization
docker system df
docker system df -v

docker ps -a

docker inspect cont5

docker inspect cont5 | grep volume -i

RESOURCE MANAGEMENT:
--------------------
By default, docker containers will not have any limits for the resources like cpu ram and memory so we need to restrict resource use for container.

By default docker containers will use host resources(cpu, ram, rom)
Resource limits of docker container should not exceed the docker host limits.

docker stats  --> to check live cpu and memory

docker run -it --name cont7 --cpus="0.1" --memory="300mb" ubuntu
docker update cont7 --cpus="0.7" --memory="300mb"

JENKINS SETUP BY DOCKER:
docker run -it -d --name jenkins -p 8080:8080 jenkins/jenkins:lts
-- docker exec -it jenkins /bin/bash


======== Delete all container ============
docker kill $(docker ps -aq)  

docker rm $(docker ps -aq)

docker ps -a

======== Delete images =====================
docker rmi -f $(docker images -q)

=========================================

======================================================
Docker Compose
======================================================

Before docker compose how we use to do?



Lets Use HDFC Bank example : internetbanking, MobileBanking, Insurance and Loans

We need to create for all modules a separate containers with some webserver to run, for this write Dockerfile

Create a directory called internetbanking , MobileBanking, Insurance and Loans

In Every directory have index.html and Dockerfile.

Create a image and container with that index.html

how?

yum install -y git

git clone https://github.com/ReyazShaik/hdfcwebsite.git

-- cd hdfcwebsite

-- cd internetbanking

Here already index.html is available, just create a Dockerfile

vi Dockerfile

FROM ubuntu
RUN apt update -y
RUN apt install apache2 -y
COPY index.html /var/www/html
CMD ["/usr/sbin/apachectl", "-D", "FOREGROUND"]

-- docker build -t internetbanking:v1 .

-- docker run -itd --name cont1 -p 81:80 internetbanking:v1

-- docker ps -a

http://instanceip:81

-- docker logs cont1 [If required]

-----------

MobileBanking
------------

cd ..

cd mobilebanking

vi Dockerfile


FROM ubuntu
RUN apt update -y
RUN apt install apache2 -y
COPY index.html /var/www/html
CMD ["/usr/sbin/apachectl", "-D", "FOREGROUND"]


-- docker build -t mobilebanking:v1 .

-- docker run -itd --name cont2 -p 82:80 mobilebanking:v1

http://instanceip:82

------------

Insurance
---------
cd ..
cd insurance

vi Dockerfile


FROM ubuntu
RUN apt update -y
RUN apt install apache2 -y
COPY index.html /var/www/html
CMD ["/usr/sbin/apachectl", "-D", "FOREGROUND"]


docker build -t insurance:v1 .

docker run -itd --name cont3 -p 83:80 insurance:v1

http://instanceip:83

docker ps -a

docker images
--------------------------------------------------

Loans
---------
cd ..
cd loans

vi Dockerfile


FROM ubuntu
RUN apt update -y
RUN apt install apache2 -y
COPY index.html /var/www/html
CMD ["/usr/sbin/apachectl", "-D", "FOREGROUND"]


docker build -t loan:v1 .

docker run -itd --name cont4 -p 83:80 loan:v1

http://instanceip:83

docker ps -a

docker images


What ever we did is not good process and not used in realtime - use docker compose


Docker Compose
-------------

Docker Compose is a tool that allows you to define and run multi-container Docker applications using a YAML file (docker-compose.yml). Instead of running multiple docker run commands manually, you can define everything in one file and start your services with a single command.

Docker Compose is a tool for defining and running multi-container Docker applications.

With Docker Compose, you can use a YAML file to define the services, networks, and volumes required for your application, and then bring up the entire stack with a single command.

It is a tool used to create multiple containers.

It will work on single host.

we can create, stop, start and delete all containers together

we can write a file called docker-compose which will be on yaml format.

Docker Compose Installation
---------------------------

vi dockercompose.sh

sudo curl -L "https://github.com/docker/compose/releases/download/1.29.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
ls /usr/local/bin/
sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
docker-compose version

sh dockercompose.sh


First, lets kill all containers

docker kill $(docker ps -a -q)

docker rm $(docker ps -a -q)


vi docker-compose.yml

version: '3.8'
services:
  internetbanking:
    image: internetbanking:v1
    ports:
      - "81:80"
  mobilebanking:
    image: mobilebanking:v1
    ports:
      - "82:80"
  insurance:
    image: insurance:v1
    ports:
      - "83:80"
  loan:
    image: loans:v1
    ports:
      - "84:80"

docker ps -a ---> No containers

docker-compose up -d  --> detach mode

docker-compose ps

refresh http://IP:81 and all in browser

docker-compose stop
docker-compose start
docker-compose kill -- to stop, use stop or kill
docker-compose start
docker-compose

TO remove containers first kill and rm

docker-compose kill
docker-compose rm

To create container again

docker-compose up -d
docker-compose ps
docker-compose pause
docker-compose unpause

docker-compose logs

docker-compose images --> these images are managed by docker-images , docker images shows managed by docker

docker-compose top

docker-compose restart

docker-compose scale loan=10  --> it will create but port conflict will come , if you want to scale we have dockerswarm

docker-compose down --> it will stop and kill automatically


CHANGING THE DEFULT FILE:

by default the docker-compose will support the following names
docker-compose.yml, docker-compose.yaml, compose.yml, compose.yaml

mv docker-compose.yml reyaz.yml
docker-compose up -d    : throws an error

docker-compose -f reyaz.yml up -d
docker-compose -f reyaz.yml ps
docker-compose -f reyaz.yml down
